# xbuilder Release Workflow
# Ëá™Âä®ÊûÑÂª∫Â§öÂπ≥Âè∞‰∫åËøõÂà∂Âπ∂ÂèëÂ∏ÉÂà∞ GitHub Release

name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  GO_VERSION: '1.25'
  BINARY_NAME: 'xbuilder'

jobs:
  # Job 1: Â§öÂπ≥Âè∞ÁºñËØë
  build:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          # macOS
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          # Windows
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
          # FreeBSD
          - goos: freebsd
            goarch: amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          # ËÆæÁΩÆËæìÂá∫Êñá‰ª∂Âêç
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi
          OUTPUT_NAME="${{ env.BINARY_NAME }}-${GOOS}-${GOARCH}${EXT}"

          # ÁºñËØë (Ê≥®ÂÖ•ÁâàÊú¨‰ø°ÊÅØ)
          echo "Building ${OUTPUT_NAME}..."
          go build -ldflags="-s -w -X github.com/xiaolfeng/builder-cli/pkg/version.Version=${{ steps.version.outputs.VERSION }}" \
            -o "${OUTPUT_NAME}" .

          # ÁîüÊàêÊ†°È™åÂíå
          sha256sum "${OUTPUT_NAME}" > "${OUTPUT_NAME}.sha256"

          echo "Build complete: ${OUTPUT_NAME}"
          ls -la "${OUTPUT_NAME}"*

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ${{ env.BINARY_NAME }}-${{ matrix.goos }}-${{ matrix.goarch }}*
          retention-days: 1

  # Job 2: ÂêàÂπ∂Ê†°È™åÂíå
  checksum:
    name: Generate checksums
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge checksums
        run: |
          echo "Merging checksums..."
          cat artifacts/*/*.sha256 > checksums.txt
          echo "=== checksums.txt ==="
          cat checksums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: checksums.txt
          retention-days: 1

  # Job 3: ‰∏ä‰º†Âà∞ Release
  upload:
    name: Upload release assets
    needs: [build, checksum]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release

          # Â§çÂà∂ÊâÄÊúâ‰∫åËøõÂà∂Êñá‰ª∂
          for dir in artifacts/${{ env.BINARY_NAME }}-*/; do
            cp "$dir"${{ env.BINARY_NAME }}-* release/ 2>/dev/null || true
          done

          # Â§çÂà∂ÂêàÂπ∂ÁöÑÊ†°È™åÂíåÊñá‰ª∂
          cp artifacts/checksums/checksums.txt release/

          # Â§çÂà∂ÂÆâË£ÖËÑöÊú¨
          cp scripts/install.sh release/
          cp scripts/install.ps1 release/
          cp scripts/uninstall.sh release/
          cp scripts/uninstall.ps1 release/

          echo "=== Release files ==="
          ls -la release/

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 4: Êõ¥Êñ∞ Homebrew Tap (ÂèØÈÄâ)
  update-homebrew:
    name: Update Homebrew Formula
    needs: upload
    runs-on: ubuntu-latest
    if: ${{ vars.HOMEBREW_TAP_ENABLED == 'true' }}
    continue-on-error: true

    steps:
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # ÁîüÊàêÁ±ªÂêçÂêéÁºÄÔºàÂéªÊéâÁÇπÔºåÂ¶Ç 0.0.4 ‚Üí 004Ôºâ
          CLASS_SUFFIX=$(echo "$VERSION" | tr -d '.')
          echo "class_suffix=$CLASS_SUFFIX" >> $GITHUB_OUTPUT
          echo "Updating Homebrew Formula to version: $VERSION"

      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Download checksums
        uses: actions/download-artifact@v4
        with:
          name: checksums
          path: .

      - name: Get old version
        id: old_version
        working-directory: homebrew-tap
        run: |
          FORMULA_FILE="Formula/x/${{ env.BINARY_NAME }}.rb"
          if [ -f "$FORMULA_FILE" ]; then
            OLD_VERSION=$(grep -oP 'version "\K[0-9]+\.[0-9]+\.[0-9]+' "$FORMULA_FILE" || echo "")
            if [ -n "$OLD_VERSION" ]; then
              echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
              OLD_CLASS_SUFFIX=$(echo "$OLD_VERSION" | tr -d '.')
              echo "old_class_suffix=$OLD_CLASS_SUFFIX" >> $GITHUB_OUTPUT
              echo "Current version in Formula: $OLD_VERSION"
            else
              echo "old_version=" >> $GITHUB_OUTPUT
              echo "No existing version found"
            fi
          else
            echo "old_version=" >> $GITHUB_OUTPUT
            echo "Formula file does not exist yet"
          fi

      - name: Create versioned Formula for old version
        if: ${{ steps.old_version.outputs.old_version != '' }}
        working-directory: homebrew-tap
        env:
          OLD_VERSION: ${{ steps.old_version.outputs.old_version }}
          OLD_CLASS_SUFFIX: ${{ steps.old_version.outputs.old_class_suffix }}
        run: |
          VERSIONED_FILE="Formula/x/${{ env.BINARY_NAME }}@${OLD_VERSION}.rb"

          if [ -f "$VERSIONED_FILE" ]; then
            echo "Versioned Formula already exists: $VERSIONED_FILE"
            exit 0
          fi

          echo "Creating versioned Formula: $VERSIONED_FILE"

          # Â§çÂà∂‰∏ª Formula
          cp "Formula/x/${{ env.BINARY_NAME }}.rb" "$VERSIONED_FILE"

          # ‰øÆÊîπÊñá‰ª∂Â§¥Ê≥®Èáä
          sed -i "s/# Formula for ${{ env.BINARY_NAME }}/# Formula for ${{ env.BINARY_NAME }}@${OLD_VERSION}/" "$VERSIONED_FILE"

          # ‰øÆÊîπÁ±ªÂêç: Xbuilder ‚Üí XbuilderATXXX
          sed -i "s/class Xbuilder < Formula/class XbuilderAT${OLD_CLASS_SUFFIX} < Formula/" "$VERSIONED_FILE"

          # Âú® caveats ‰∏≠Ê∑ªÂä†Âõ∫ÂÆöÁâàÊú¨Ë≠¶ÂëäÔºàÂ¶ÇÊûúÂ≠òÂú® caveatsÔºâ
          if grep -q "def caveats" "$VERSIONED_FILE"; then
            sed -i '/def caveats/,/end/s/EOS/\n      ‚ö†Ô∏è  Ê≥®ÊÑèÔºöËøôÊòØ‰∏Ä‰∏™Âõ∫ÂÆöÁâàÊú¨ÁöÑ Formula\n      - Ê≠§ÁâàÊú¨‰∏ç‰ºöËá™Âä®Êõ¥Êñ∞Âà∞Êõ¥È´òÁâàÊú¨\n      - Â¶ÇÈúÄÊúÄÊñ∞ÁâàÊú¨ÔºåËØ∑‰ΩøÁî®Ôºöbrew install ${{ env.BINARY_NAME }}\n    EOS/' "$VERSIONED_FILE"
          fi

          echo "Created versioned Formula: $VERSIONED_FILE"

      - name: Update main Formula
        working-directory: homebrew-tap
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # ÂàõÂª∫ Formula ÁõÆÂΩïÔºàÊåâÈ¶ñÂ≠óÊØçÂàÜÁªÑÔºâ
          mkdir -p Formula/x

          # Ëé∑ÂèñÂêÑÂπ≥Âè∞ÁöÑ SHA256
          DARWIN_AMD64_SHA=$(grep 'darwin-amd64' ../checksums.txt | awk '{print $1}')
          DARWIN_ARM64_SHA=$(grep 'darwin-arm64' ../checksums.txt | awk '{print $1}')
          LINUX_AMD64_SHA=$(grep 'linux-amd64' ../checksums.txt | awk '{print $1}')
          LINUX_ARM64_SHA=$(grep 'linux-arm64' ../checksums.txt | awk '{print $1}')

          FORMULA_FILE="Formula/x/${{ env.BINARY_NAME }}.rb"

          # ÁîüÊàê Formula
          cat > "$FORMULA_FILE" << 'EOF'
          # Formula for xbuilder
          # ÊûÑÂª∫ÈÉ®ÁΩ≤ÊµÅÊ∞¥Á∫ø CLI Â∑•ÂÖ∑
          class Xbuilder < Formula
            desc "CLI tool for building and deploying applications with pipeline support"
            homepage "https://github.com/${{ github.repository }}"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${{ github.repository }}/releases/download/vVERSION_PLACEHOLDER/${{ env.BINARY_NAME }}-darwin-arm64"
                sha256 "DARWIN_ARM64_SHA_PLACEHOLDER"
              else
                url "https://github.com/${{ github.repository }}/releases/download/vVERSION_PLACEHOLDER/${{ env.BINARY_NAME }}-darwin-amd64"
                sha256 "DARWIN_AMD64_SHA_PLACEHOLDER"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/${{ github.repository }}/releases/download/vVERSION_PLACEHOLDER/${{ env.BINARY_NAME }}-linux-arm64"
                sha256 "LINUX_ARM64_SHA_PLACEHOLDER"
              else
                url "https://github.com/${{ github.repository }}/releases/download/vVERSION_PLACEHOLDER/${{ env.BINARY_NAME }}-linux-amd64"
                sha256 "LINUX_AMD64_SHA_PLACEHOLDER"
              end
            end

            def install
              if OS.mac?
                if Hardware::CPU.arm?
                  bin.install "${{ env.BINARY_NAME }}-darwin-arm64" => "${{ env.BINARY_NAME }}"
                else
                  bin.install "${{ env.BINARY_NAME }}-darwin-amd64" => "${{ env.BINARY_NAME }}"
                end
              elsif OS.linux?
                if Hardware::CPU.arm?
                  bin.install "${{ env.BINARY_NAME }}-linux-arm64" => "${{ env.BINARY_NAME }}"
                else
                  bin.install "${{ env.BINARY_NAME }}-linux-amd64" => "${{ env.BINARY_NAME }}"
                end
              end
            end

            def caveats
              <<~EOS
                üéâ ${{ env.BINARY_NAME }} Â∑≤ÊàêÂäüÂÆâË£ÖÔºÅ

                Âø´ÈÄüÂºÄÂßãÔºö
                  ${{ env.BINARY_NAME }} --help     # Êü•ÁúãÂ∏ÆÂä©
                  ${{ env.BINARY_NAME }} init       # ÂàùÂßãÂåñÈÖçÁΩÆ
                  ${{ env.BINARY_NAME }} run        # ËøêË°åÊûÑÂª∫

                ÊñáÊ°£Ôºöhttps://github.com/${{ github.repository }}
              EOS
            end

            test do
              system "#{bin}/${{ env.BINARY_NAME }}", "--version"
            end
          end
          EOF

          # ÊõøÊç¢Âç†‰ΩçÁ¨¶
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" "$FORMULA_FILE"
          sed -i "s/DARWIN_AMD64_SHA_PLACEHOLDER/${DARWIN_AMD64_SHA}/g" "$FORMULA_FILE"
          sed -i "s/DARWIN_ARM64_SHA_PLACEHOLDER/${DARWIN_ARM64_SHA}/g" "$FORMULA_FILE"
          sed -i "s/LINUX_AMD64_SHA_PLACEHOLDER/${LINUX_AMD64_SHA}/g" "$FORMULA_FILE"
          sed -i "s/LINUX_ARM64_SHA_PLACEHOLDER/${LINUX_ARM64_SHA}/g" "$FORMULA_FILE"

          echo "Updated Formula:"
          cat "$FORMULA_FILE"

      - name: Commit and push changes
        working-directory: homebrew-tap
        env:
          VERSION: ${{ steps.version.outputs.version }}
          OLD_VERSION: ${{ steps.old_version.outputs.old_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Ê£ÄÊü•ÊòØÂê¶ÊúâÂèòÊõ¥
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "No changes to commit (version might already be up to date)"
            exit 0
          fi

          git add Formula/x/

          # Âà§Êñ≠ÊòØÂê¶ÂàõÂª∫‰∫ÜÁâàÊú¨Âåñ Formula
          if [ -n "$OLD_VERSION" ] && [ -f "Formula/x/${{ env.BINARY_NAME }}@${OLD_VERSION}.rb" ] && git diff --cached --name-only | grep -q "@"; then
            git commit -m "chore(${{ env.BINARY_NAME }}): bump to v${VERSION}, archive v${OLD_VERSION}

          - Update ${{ env.BINARY_NAME }}.rb to version ${VERSION}
          - Create ${{ env.BINARY_NAME }}@${OLD_VERSION}.rb for version pinning

          Automated update from ${{ env.BINARY_NAME }} release workflow.
          Release: https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
          else
            git commit -m "chore(${{ env.BINARY_NAME }}): bump version to ${VERSION}

          Automated update from ${{ env.BINARY_NAME }} release workflow.
          Release: https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
          fi

          git push origin master
          echo "‚úÖ Successfully updated homebrew-tap!"
