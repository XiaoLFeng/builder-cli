# xbuilder é¡¹ç›® Makefile
# ç”Ÿæˆå‘½ä»¤: xbuilder gen makefile

.PHONY: all init gen validate build docker-build docker-push deploy-dev deploy-staging deploy-prod clean help

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å˜é‡é…ç½®
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PROJECT_NAME ?= {{.ProjectName}}
REGISTRY     ?= {{.Registry}}
VERSION      ?= $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_DATE   ?= $(shell date -u +"%Y-%m-%dT%H:%M:%SZ")
GIT_COMMIT   ?= $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# é»˜è®¤ç›®æ ‡
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
all: build

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# xbuilder å‘½ä»¤
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init:
	@echo "ğŸ“¦ åˆå§‹åŒ– xbuilder é…ç½®..."
	xbuilder init

gen:
	@echo "ğŸ“„ ç”Ÿæˆå®Œæ•´é…ç½®æ¨¡æ¿..."
	xbuilder gen config --scripts

validate:
	@echo "âœ… éªŒè¯é…ç½®æ–‡ä»¶..."
	xbuilder validate

build:
	@echo "ğŸš€ è¿è¡Œ xbuilder æ„å»ºæµæ°´çº¿..."
	xbuilder build

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Docker æ„å»º
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
docker-build:
	@echo "ğŸ³ æ„å»º Docker é•œåƒ..."
	docker build \
		--build-arg VERSION=$(VERSION) \
		--build-arg BUILD_DATE=$(BUILD_DATE) \
		--build-arg GIT_COMMIT=$(GIT_COMMIT) \
		-t $(REGISTRY)/$(PROJECT_NAME):$(VERSION) \
		-t $(REGISTRY)/$(PROJECT_NAME):latest \
		.

docker-push:
	@echo "ğŸ“¤ æ¨é€ Docker é•œåƒ..."
	docker push $(REGISTRY)/$(PROJECT_NAME):$(VERSION)
	docker push $(REGISTRY)/$(PROJECT_NAME):latest

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# éƒ¨ç½²
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
deploy-dev:
	@echo "ğŸš€ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
	docker-compose -f docker-compose.dev.yaml up -d

deploy-staging:
	@echo "ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
	docker-compose -f docker-compose.test.yaml up -d

deploy-prod:
	@echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
	docker-compose -f docker-compose.yaml up -d

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æ¸…ç†
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©..."
	rm -rf target/ dist/ bin/
	docker system prune -f

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å¸®åŠ©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
help:
	@echo "xbuilder Makefile ä½¿ç”¨å¸®åŠ©"
	@echo ""
	@echo "ç”¨æ³•: make [ç›®æ ‡]"
	@echo ""
	@echo "ç›®æ ‡:"
	@echo "  init          åˆå§‹åŒ– xbuilder é…ç½®"
	@echo "  gen           ç”Ÿæˆå®Œæ•´é…ç½®æ¨¡æ¿"
	@echo "  validate      éªŒè¯é…ç½®æ–‡ä»¶"
	@echo "  build         è¿è¡Œ xbuilder æ„å»ºæµæ°´çº¿"
	@echo "  docker-build  æ„å»º Docker é•œåƒ"
	@echo "  docker-push   æ¨é€ Docker é•œåƒ"
	@echo "  deploy-dev    éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ"
	@echo "  deploy-staging éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
	@echo "  deploy-prod   éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
	@echo "  clean         æ¸…ç†æ„å»ºäº§ç‰©"
	@echo "  help          æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "å˜é‡:"
	@echo "  PROJECT_NAME  é¡¹ç›®åç§° (é»˜è®¤: {{.ProjectName}})"
	@echo "  REGISTRY      é•œåƒä»“åº“ (é»˜è®¤: {{.Registry}})"
	@echo "  VERSION       ç‰ˆæœ¬å· (é»˜è®¤: git tag)"
