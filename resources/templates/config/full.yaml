# xbuilder å®Œæ•´é…ç½®ç¤ºä¾‹
# æ–‡æ¡£: https://github.com/xiaolfeng/builder-cli

version: "1.0"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# é¡¹ç›®åŸºæœ¬ä¿¡æ¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
project:
  name: "my-microservices"
  description: "å¾®æœåŠ¡é¡¹ç›®æ„å»ºé…ç½®"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# å…¨å±€å˜é‡ (å¯åœ¨é…ç½®ä¸­ä½¿ç”¨ ${VAR_NAME} å¼•ç”¨)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
variables:
  APP_VERSION: "1.0.0"
  REGISTRY_PREFIX: "registry.example.com/myproject"
  DEPLOY_ENV: "production"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Docker Registry é…ç½®
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
registries:
  default:
    url: "registry.example.com"
    username: "${DOCKER_USERNAME}"      # ä»ç¯å¢ƒå˜é‡è¯»å–
    password: "${DOCKER_PASSWORD}"

  aliyun:
    url: "registry.cn-hangzhou.aliyuncs.com"
    username: "${ALIYUN_USERNAME}"
    password: "${ALIYUN_PASSWORD}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SSH æœåŠ¡å™¨é…ç½®
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
servers:
  production:
    host: "192.168.1.100"
    port: 22
    username: "deploy"
    auth:
      type: "key"                       # "password" | "key"
      key_path: "~/.ssh/id_rsa"

  staging:
    host: "192.168.1.101"
    port: 22
    username: "deploy"
    auth:
      type: "password"
      password: "${SSH_PASSWORD}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# æ„å»ºæµæ°´çº¿
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pipeline:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # é˜¶æ®µ 1: Maven æ„å»º
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - stage: "maven-build"
    name: "Maven æ„å»º"
    tasks:
      - name: "ç¼–è¯‘æ‰“åŒ…"
        type: "maven"
        config:
          # æ–¹å¼1: ç›´æ¥å‘½ä»¤
          command: "mvn clean package -DskipTests -P prod"
          # æ–¹å¼2: æ‰§è¡Œè„šæœ¬
          # script: "./scripts/build.sh"
          working_dir: "."
          timeout: 600                  # è¶…æ—¶æ—¶é—´ (ç§’)

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # é˜¶æ®µ 2: Docker æ„å»º (æ”¯æŒå¹¶è¡Œ)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - stage: "docker-build"
    name: "Docker é•œåƒæ„å»º"
    parallel: true                      # å¯ç”¨å¹¶è¡Œæ‰§è¡Œ
    tasks:
      - name: "ç”¨æˆ·æœåŠ¡é•œåƒ"
        type: "docker-build"
        config:
          dockerfile: "./user-service/Dockerfile"
          context: "./user-service"
          image_name: "${REGISTRY_PREFIX}/user-service"
          tag: "${APP_VERSION}"
          build_args:
            JAR_FILE: "target/*.jar"
            BUILD_ENV: "${DEPLOY_ENV}"

      - name: "è®¢å•æœåŠ¡é•œåƒ"
        type: "docker-build"
        config:
          dockerfile: "./order-service/Dockerfile"
          context: "./order-service"
          image_name: "${REGISTRY_PREFIX}/order-service"
          tag: "${APP_VERSION}"

      # å¤šå¹³å°æ„å»ºç¤ºä¾‹
      - name: "ç½‘å…³æœåŠ¡é•œåƒ (å¤šå¹³å°)"
        type: "docker-build"
        config:
          dockerfile: "./gateway-service/Dockerfile"
          context: "./gateway-service"
          image_name: "${REGISTRY_PREFIX}/gateway-service"
          tag: "${APP_VERSION}"
          # å¤šå¹³å°æ„å»º (éœ€è¦ docker buildx)
          platforms:
            - "linux/amd64"
            - "linux/arm64"
          # å¤šå¹³å°æ„å»ºæ—¶æ˜¯å¦è‡ªåŠ¨æ¨é€ (é»˜è®¤ true)
          # è®¾ä¸º false åˆ™ä»…æ„å»ºä¸æ¨é€ï¼Œä½†é•œåƒä¸ä¼šä¿å­˜åˆ°æœ¬åœ° (buildx é™åˆ¶)
          push_on_build: true
          # å¤šå¹³å°æ„å»ºæ—¶æ˜¯å¦åŒæ—¶æ¨é€ latest æ ‡ç­¾ (ä»…åœ¨ push_on_build: true æ—¶ç”Ÿæ•ˆ)
          push_latest_on_build: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # é˜¶æ®µ 3: Docker æ¨é€
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - stage: "docker-push"
    name: "æ¨é€é•œåƒåˆ° Registry"
    tasks:
      - name: "æ¨é€æ‰€æœ‰é•œåƒ"
        type: "docker-push"
        config:
          registry: "default"
          # ä½¿ç”¨ auto è‡ªåŠ¨æ¨é€ä¸Šä¸€é˜¶æ®µæ„å»ºçš„é•œåƒ
          auto: true
          # åŒæ—¶æ¨é€ latest æ ‡ç­¾ (å¯é€‰)
          push_latest: false
          # æˆ–è€…æ‰‹åŠ¨æŒ‡å®šé•œåƒåˆ—è¡¨
          # images:
          #   - "${REGISTRY_PREFIX}/user-service:${APP_VERSION}"
          #   - "${REGISTRY_PREFIX}/order-service:${APP_VERSION}"
          #   - "${REGISTRY_PREFIX}/gateway-service:${APP_VERSION}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # é˜¶æ®µ 4: éƒ¨ç½²
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - stage: "deploy"
    name: "éƒ¨ç½²åˆ°æœåŠ¡å™¨"
    tasks:
      - name: "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        type: "ssh"
        config:
          server: "production"
          # æ–¹å¼1: å†…è”å‘½ä»¤
          commands:
            - "cd /opt/services"
            - "docker-compose pull"
            - "docker-compose up -d"
            - "docker system prune -f"
          # æ–¹å¼2: æ‰§è¡Œæœ¬åœ°è„šæœ¬ (ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨æ‰§è¡Œ)
          # local_script: "./scripts/deploy.sh"
          timeout: 300

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# é’©å­ (å¯é€‰)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hooks:
  pre_build:
    - "echo 'ğŸš€ å¼€å§‹æ„å»º...'"
    - "date"
  post_build:
    - "echo 'âœ… æ„å»ºå®Œæˆ!'"
    - "date"
  on_failure:
    - "echo 'âŒ æ„å»ºå¤±è´¥!'"
    # - "./scripts/notify-failure.sh"
